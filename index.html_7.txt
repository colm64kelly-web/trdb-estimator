<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRDB ‚Äì GITHUB LIVE!</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YOUR-GA4-ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-YOUR-GA4-ID');
    </script>

    <!-- Firebase SDKs -->
    <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        header {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #f97316;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { 
            font-size: 28px; 
            font-weight: bold; 
            color: #f97316;
            text-shadow: 0 2px 10px rgba(249, 115, 22, 0.3);
        }

        .user-section {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-info {
            color: #94a3b8;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4);
        }

        .btn-secondary {
            background: #334155;
            color: white;
        }

        .btn-secondary:hover { background: #475569; }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover { background: #dc2626; }

        .hero {
            text-align: center;
            padding: 80px 20px;
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.1) 0%, rgba(30, 41, 59, 0.5) 100%);
            border-radius: 20px;
            margin: 40px 0;
        }

        .hero h1 {
            font-size: 48px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 20px;
            color: #94a3b8;
            margin-bottom: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.8);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #334155;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #f97316;
            box-shadow: 0 10px 30px rgba(249, 115, 22, 0.2);
        }

        .stat-icon {
            font-size: 40px;
            margin-bottom: 15px;
            color: #f97316;
        }

        .stat-title {
            font-size: 24px;
            font-weight: bold;
            color: #f97316;
            margin-bottom: 10px;
        }

        .stat-desc {
            color: #94a3b8;
            font-size: 14px;
        }

        .card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .card h2 {
            color: #f97316;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .market-btn {
            padding: 25px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid #334155;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .market-btn:hover {
            border-color: #f97316;
            background: rgba(249, 115, 22, 0.1);
            transform: translateY(-3px);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #e2e8f0;
        }

        .slider-value {
            color: #f97316;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #334155;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f97316;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f97316;
            cursor: pointer;
            border: none;
        }

        .quality-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .quality-btn {
            padding: 20px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid #334155;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: capitalize;
        }

        .quality-btn.active {
            border-color: #f97316;
            background: rgba(249, 115, 22, 0.2);
        }

        .options-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-item:hover {
            border-color: #f97316;
            background: rgba(249, 115, 22, 0.1);
        }

        .option-item.selected {
            background: rgba(19, 78, 74, 0.4);
            border-color: #14b8a6;
        }

        .option-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .estimate-highlight {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            margin: 30px 0;
            box-shadow: 0 10px 40px rgba(249, 115, 22, 0.3);
        }

        .estimate-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .estimate-amount {
            font-size: 42px;
            font-weight: bold;
            margin: 15px 0;
        }

        .estimate-details {
            font-size: 14px;
            opacity: 0.9;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }

        .detail-box {
            padding: 20px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 10px;
        }

        .detail-label {
            color: #94a3b8;
            font-size: 12px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .detail-value {
            font-size: 20px;
            font-weight: bold;
            color: white;
        }

        .breakdown-table {
            width: 100%;
            margin: 20px 0;
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #334155;
        }

        .breakdown-row.total {
            border-top: 2px solid #f97316;
            border-bottom: none;
            font-weight: bold;
            font-size: 18px;
            color: #f97316;
            padding-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: #1e293b;
            padding: 40px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #334155;
        }

        .modal h3 {
            color: #f97316;
            margin-bottom: 25px;
            font-size: 24px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #f97316;
        }

        .radio-group {
            margin: 20px 0;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option:hover {
            border-color: #f97316;
            background: rgba(249, 115, 22, 0.1);
        }

        .radio-option input[type="radio"] {
            margin-right: 12px;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .saved-estimates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .estimate-card {
            background: rgba(30, 41, 59, 0.8);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #334155;
            transition: all 0.3s;
        }

        .estimate-card:hover {
            transform: translateY(-3px);
            border-color: #f97316;
            box-shadow: 0 10px 30px rgba(249, 115, 22, 0.2);
        }

        .estimate-card-header {
            margin-bottom: 15px;
        }

        .estimate-card-title {
            font-size: 20px;
            font-weight: bold;
            color: #f97316;
            margin-bottom: 5px;
        }

        .estimate-card-meta {
            color: #94a3b8;
            font-size: 14px;
        }

        .estimate-card-date {
            color: #64748b;
            font-size: 12px;
            margin-top: 5px;
        }

        .estimate-card-amount {
            background: rgba(15, 23, 42, 0.8);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .estimate-card-price {
            font-size: 22px;
            font-weight: bold;
            color: white;
        }

        .estimate-card-actions {
            display: flex;
            gap: 10px;
        }

        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .empty-state h3 {
            font-size: 24px;
            color: #94a3b8;
            margin-bottom: 15px;
        }

        .empty-state p {
            color: #64748b;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .hero h1 { font-size: 32px; }
            .hero p { font-size: 16px; }
            .quality-grid { grid-template-columns: 1fr; }
            .market-grid { grid-template-columns: repeat(2, 1fr); }
            .estimate-amount { font-size: 28px; }
            .details-grid { grid-template-columns: 1fr; }
        }

        @media print {
            body { background: white; color: black; }
            header, .btn, .modal { display: none !important; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">TRDB</div>
            <div class="user-section">
                <div id="userControls"></div>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="app"></div>
    </div>

    <!-- Modals -->
    <div id="authModal" class="modal"></div>
    <div id="leadModal" class="modal"></div>
    <div id="detailsModal" class="modal"></div>

    <script>
        // Wait for Firebase to load
        window.addEventListener('load', function() {
            // Check if Firebase loaded
            if (typeof firebase === 'undefined') {
                document.getElementById('app').innerHTML = '<div style="text-align:center;padding:100px 20px;"><h2 style="color:#ef4444;">Error: Firebase failed to load</h2><p style="color:#94a3b8;margin-top:20px;">Please check your internet connection and refresh the page.</p></div>';
                return;
            }

            // Firebase Configuration
            const firebaseConfig = {
                apiKey: "AIzaSyBnqnkxELAW9kPjznwOm1H3Xnji28iuZ5w",
                authDomain: "trdb-estimator.firebaseapp.com",
                projectId: "trdb-estimator",
                storageBucket: "trdb-estimator.firebasestorage.app",
                messagingSenderId: "103619858937",
                appId: "1:103619858937:web:62d37b3d0c8c1fb86b2d28"
            };

            // Initialize Firebase
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
            
            const auth = firebase.auth();
            const db = firebase.firestore();

            // Market rates (AED per SqFt)
            const rates = {
                dubai: { low: 180, mid: 250, high: 350 },
                abudhabi: { low: 175, mid: 240, high: 330 },
                riyadh: { low: 170, mid: 235, high: 320 },
                jeddah: { low: 165, mid: 230, high: 310 }
            };

            class TRDBEstimator {
                constructor() {
                    this.view = 'home';
                    this.config = {
                        market: '',
                        size: 5000,
                        quality: 'standard',
                        options: {
                            furniture: false,
                            ffe: false,
                            green: false,
                            smart: false,
                            mep: false,
                            av: false
                        }
                    };
                    this.estimate = null;
                    this.user = null;
                    this.savedEstimates = [];
                    
                    this.init();
                }

                init() {
                    // Listen for auth state changes
                    auth.onAuthStateChanged((user) => {
                        this.user = user;
                        if (user) {
                            this.loadSavedEstimates();
                        } else {
                            this.savedEstimates = [];
                        }
                        this.render();
                    });
                }

                async loadSavedEstimates() {
                    if (!this.user) return;
                    
                    try {
                        const snapshot = await db.collection('estimates')
                            .where('userId', '==', this.user.uid)
                            .orderBy('savedAt', 'desc')
                            .get();
                        
                        this.savedEstimates = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        this.render();
                    } catch (error) {
                        console.error('Error loading estimates:', error);
                    }
                }

                async saveEstimate() {
                    if (!this.user) {
                        this.showAuthModal('login');
                        return;
                    }

                    try {
                        await db.collection('estimates').add({
                            userId: this.user.uid,
                            config: this.config,
                            estimate: this.estimate,
                            savedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        alert('‚úÖ Estimate saved successfully!');
                        await this.loadSavedEstimates();
                    } catch (error) {
                        console.error('Error saving estimate:', error);
                        alert('‚ùå Error saving estimate. Please try again.');
                    }
                }

                async deleteEstimate(id) {
                    if (!confirm('Delete this estimate?')) return;

                    try {
                        await db.collection('estimates').doc(id).delete();
                        await this.loadSavedEstimates();
                    } catch (error) {
                        console.error('Error deleting estimate:', error);
                        alert('‚ùå Error deleting estimate. Please try again.');
                    }
                }

                async loadEstimate(saved) {
                    this.config = saved.config;
                    this.estimate = saved.estimate;
                    this.view = 'results';
                    this.render();
                }

                calculateEstimate() {
                    const rate = rates[this.config.market];
                    const qualityRate = this.config.quality === 'basic' ? rate.low :
                                       this.config.quality === 'standard' ? rate.mid : rate.high;

                    let baseMin = this.config.size * qualityRate;
                    let baseMax = this.config.size * (qualityRate + 30);

                    let totalMin = baseMin;
                    let totalMax = baseMax;

                    if (this.config.options.furniture) { totalMin += baseMin * 0.10; totalMax += baseMax * 0.10; }
                    if (this.config.options.ffe) { totalMin += baseMin * 0.09; totalMax += baseMax * 0.09; }
                    if (this.config.options.green) { totalMin += baseMin * 0.08; totalMax += baseMax * 0.08; }
                    if (this.config.options.smart) { totalMin += baseMin * 0.06; totalMax += baseMax * 0.06; }
                    if (this.config.options.mep) { totalMin += baseMin * 0.18; totalMax += baseMax * 0.18; }
                    if (this.config.options.av) { totalMin += baseMin * 0.05; totalMax += baseMax * 0.05; }

                    this.estimate = {
                        base: { min: Math.round(baseMin), max: Math.round(baseMax) },
                        total: { min: Math.round(totalMin), max: Math.round(totalMax) },
                        perSqFt: { min: Math.round(totalMin / this.config.size), max: Math.round(totalMax / this.config.size) }
                    };

                    // Track event
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'calculate_estimate', {
                            market: this.config.market,
                            size: this.config.size,
                            quality: this.config.quality,
                            total_min: this.estimate.total.min
                        });
                    }
                }

                fmt(num) {
                    return num.toLocaleString();
                }

                showAuthModal(mode) {
                    const modal = document.getElementById('authModal');
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3>${mode === 'login' ? 'Login to Your Account' : 'Create Your Account'}</h3>
                            <form id="authForm">
                                ${mode === 'signup' ? '<input type="text" id="authName" class="form-input" placeholder="Full Name" required>' : ''}
                                <input type="email" id="authEmail" class="form-input" placeholder="Email Address" required>
                                <input type="password" id="authPassword" class="form-input" placeholder="Password (min 6 characters)" required>
                                <div id="authError"></div>
                                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">
                                    ${mode === 'login' ? 'Login' : 'Sign Up'}
                                </button>
                            </form>
                            <button class="btn btn-secondary" onclick="App.googleSignIn()" style="width: 100%; margin-bottom: 15px;">
                                üîç Sign in with Google
                            </button>
                            <p style="text-align: center; color: #94a3b8; margin-bottom: 15px;">
                                ${mode === 'login' ? "Don't have an account? " : "Already have an account? "}
                                <a href="#" onclick="App.showAuthModal('${mode === 'login' ? 'signup' : 'login'}'); return false;" style="color: #f97316; text-decoration: underline;">
                                    ${mode === 'login' ? 'Sign Up' : 'Login'}
                                </a>
                            </p>
                            <button class="btn btn-secondary" onclick="App.closeAuthModal()" style="width: 100%;">Cancel</button>
                        </div>
                    `;
                    modal.classList.add('active');

                    document.getElementById('authForm').onsubmit = (e) => {
                        e.preventDefault();
                        if (mode === 'login') {
                            this.login();
                        } else {
                            this.signup();
                        }
                    };
                }

                async signup() {
                    const email = document.getElementById('authEmail').value;
                    const password = document.getElementById('authPassword').value;
                    const name = document.getElementById('authName').value;
                    const errorDiv = document.getElementById('authError');

                    try {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        await userCredential.user.updateProfile({ displayName: name });
                        this.closeAuthModal();
                    } catch (error) {
                        errorDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
                    }
                }

                async login() {
                    const email = document.getElementById('authEmail').value;
                    const password = document.getElementById('authPassword').value;
                    const errorDiv = document.getElementById('authError');

                    try {
                        await auth.signInWithEmailAndPassword(email, password);
                        this.closeAuthModal();
                    } catch (error) {
                        errorDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
                    }
                }

                async googleSignIn() {
                    try {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        await auth.signInWithPopup(provider);
                        this.closeAuthModal();
                    } catch (error) {
                        console.error('Google sign-in error:', error);
                        alert('Error signing in with Google. Please try again.');
                    }
                }

                async logout() {
                    try {
                        await auth.signOut();
                        this.view = 'home';
                        this.render();
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                }

                closeAuthModal() {
                    document.getElementById('authModal').classList.remove('active');
                }

                showLeadModal() {
                    const modal = document.getElementById('leadModal');
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3>Get Your Detailed Estimate</h3>
                            <form id="leadForm">
                                <input type="text" name="name" class="form-input" placeholder="Your Name" required>
                                <input type="email" name="email" class="form-input" placeholder="Email Address" required>
                                <input type="text" name="company" class="form-input" placeholder="Company Name (Optional)">
                                
                                <div class="form-group">
                                    <label>How would you like to receive your estimate?</label>
                                    <div class="radio-group">
                                        <label class="radio-option">
                                            <input type="radio" name="delivery" value="email" checked>
                                            üìß Email me the details
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="delivery" value="pdf">
                                            üìÑ Download PDF
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="delivery" value="whatsapp">
                                            üí¨ Share via WhatsApp
                                        </label>
                                    </div>
                                </div>

                                <div class="button-group">
                                    <button type="button" class="btn btn-secondary" onclick="App.closeLeadModal()">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Submit</button>
                                </div>
                            </form>
                        </div>
                    `;
                    modal.classList.add('active');

                    document.getElementById('leadForm').onsubmit = (e) => {
                        e.preventDefault();
                        this.submitLead(e.target);
                    };
                }

                async submitLead(form) {
                    const formData = new FormData(form);
                    const delivery = formData.get('delivery');

                    // Track event
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'submit_lead', {
                            delivery_method: delivery,
                            market: this.config.market
                        });
                    }

                    if (delivery === 'pdf') {
                        this.generatePDF();
                        alert('‚úÖ PDF opened! Check your email for details too.');
                    } else if (delivery === 'whatsapp') {
                        const message = `TRDB Estimate: AED ${this.fmt(this.estimate.total.min)} - ${this.fmt(this.estimate.total.max)} for ${this.fmt(this.config.size)} SqFt in ${this.config.market.toUpperCase()}`;
                        window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
                    }

                    // Send to Netlify function
                    try {
                        await fetch('/.netlify/functions/capture-lead', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: formData.get('name'),
                                email: formData.get('email'),
                                company: formData.get('company'),
                                delivery,
                                config: this.config,
                                estimate: this.estimate
                            })
                        });
                    } catch (error) {
                        console.error('Error submitting lead:', error);
                    }

                    this.closeLeadModal();
                }

                closeLeadModal() {
                    document.getElementById('leadModal').classList.remove('active');
                }

                showDetailsModal() {
                    const modal = document.getElementById('detailsModal');
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3>Complete Project Scope</h3>
                            
                            <div style="margin-bottom: 25px;">
                                <h4 style="color: #f97316; margin-bottom: 15px;">‚úÖ What's Included</h4>
                                <ul style="line-height: 1.8; color: #cbd5e1; padding-left: 20px;">
                                    <li>Complete architectural fit-out (partitions, doors, ceilings, flooring, finishes)</li>
                                    <li>Full MEP installations (HVAC, electrical, lighting, fire alarm, plumbing, BMS)</li>
                                    <li>Contractor services (supervision, QC, safety, overhead, 12-month warranty)</li>
                                </ul>
                            </div>

                            <div style="margin-bottom: 25px;">
                                <h4 style="color: #f97316; margin-bottom: 15px;">‚ùå NOT Included (20-35% additional)</h4>
                                <ul style="line-height: 1.8; color: #cbd5e1; padding-left: 20px;">
                                    <li>Professional fees: Design consultants (5-8%), Project management (3-5%), Engineers (2-4%)</li>
                                    <li>Authority approvals: Building permits, Civil Defense, Municipality fees</li>
                                    <li>Landlord requirements: Security deposits, NOC fees, access charges</li>
                                    <li>VAT (5% UAE, 15% KSA), contingency reserves (5-10%), insurance</li>
                                </ul>
                            </div>

                            <button class="btn btn-primary" onclick="App.closeDetailsModal()" style="width: 100%;">Close</button>
                        </div>
                    `;
                    modal.classList.add('active');
                }

                closeDetailsModal() {
                    document.getElementById('detailsModal').classList.remove('active');
                }

                generatePDF() {
                    const e = this.estimate;
                    const pdfWindow = window.open('', '_blank');
                    pdfWindow.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>TRDB Estimate</title><style>@page{margin:20mm;size:A4 portrait}body{font-family:Arial;font-size:11pt;color:#1a1a1a}.header{border-bottom:3px solid #f97316;padding-bottom:20px;margin-bottom:30px}.company{font-size:24pt;font-weight:bold;color:#f97316}h2{color:#f97316;font-size:14pt;margin:20px 0 10px;border-bottom:2px solid #f97316;padding-bottom:5px}.highlight{background:#fff3e0;border:3px solid #f97316;padding:20px;text-align:center;margin:20px 0;border-radius:10px}.amount{font-size:28pt;font-weight:bold;color:#f97316}table{width:100%;border-collapse:collapse;margin:15px 0}td{padding:8px 0;border-bottom:1px solid #e0e0e0}.total{font-weight:bold;border-top:2px solid #f97316;padding-top:10px}ul{line-height:1.8}.no-print{position:fixed;top:20px;right:20px}@media print{.no-print{display:none}}</style></head><body><div class="header"><div class="company">TRDB</div><div style="font-size:10pt;color:#666">Professional Fit-Out Cost Estimates</div><div style="font-size:9pt;color:#999;margin-top:10px">Generated: ${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}</div></div><h2>Project Overview</h2><table><tr><td><strong>Location:</strong></td><td>${this.config.market.toUpperCase()}</td></tr><tr><td><strong>Project Size:</strong></td><td>${this.fmt(this.config.size)} SqFt</td></tr><tr><td><strong>Quality Level:</strong></td><td>${this.config.quality.charAt(0).toUpperCase()+this.config.quality.slice(1)}</td></tr><tr><td><strong>Cost per SqFt:</strong></td><td>AED ${e.perSqFt.min} - ${e.perSqFt.max}</td></tr></table><div class="highlight"><div style="font-size:11pt;color:#666;margin-bottom:10px">TOTAL ESTIMATED INVESTMENT</div><div class="amount">AED ${this.fmt(e.total.min)} - ${this.fmt(e.total.max)}</div><div style="font-size:9pt;color:#666;margin-top:10px">Construction-only costs based on ${this.config.market.toUpperCase()} market rates</div></div><h2>Cost Breakdown</h2><table><tr><td>Base Construction</td><td style="text-align:right">AED ${this.fmt(e.base.min)} - ${this.fmt(e.base.max)}</td></tr>${this.config.options.furniture?`<tr><td>Furniture Supply (+10%)</td><td style="text-align:right">+AED ${this.fmt(Math.round(e.base.min*0.10))} - ${this.fmt(Math.round(e.base.max*0.10))}</td></tr>`:''}${this.config.options.ffe?`<tr><td>Loose FF&E (+9%)</td><td style="text-align:right">+AED ${this.fmt(Math.round(e.base.min*0.09))} - ${this.fmt(Math.round(e.base.max*0.09))}</td></tr>`:''}${this.config.options.green?`<tr><td>Green/LEED (+8%)</td><td style="text-align:right">+AED ${this.fmt(Math.round(e.base.min*0.08))} - ${this.fmt(Math.round(e.base.max*0.08))}</td></tr>`:''}${this.config.options.smart?`<tr><td>Smart Workplace (+6%)</td><td style="text-align:right">+AED ${this.fmt(Math.round(e.base.min*0.06))} - ${this.fmt(Math.round(e.base.max*0.06))}</td></tr>`:''}${this.config.options.mep?`<tr><td>Full MEP Plant (+18%)</td><td style="text-align:right">+AED ${this.fmt(Math.round(e.base.min*0.18))} - ${this.fmt(Math.round(e.base.max*0.18))}</td></tr>`:''}${this.config.options.av?`<tr><td>Advanced AV/IT (+5%)</td><td style="text-align:right">+AED ${this.fmt(Math.round(e.base.min*0.05))} - ${this.fmt(Math.round(e.base.max*0.05))}</td></tr>`:''}< tr class="total"><td><strong>TOTAL ESTIMATE</strong></td><td style="text-align:right"><strong>AED ${this.fmt(e.total.min)} - ${this.fmt(e.total.max)}</strong></td></tr></table><h2>What's Included</h2><ul><li>Complete architectural fit-out (partitions, doors, ceilings, flooring, finishes)</li><li>Full MEP installations (HVAC, electrical, lighting, fire alarm, plumbing, BMS)</li><li>Contractor services (supervision, QC, safety, overhead, 12-month warranty)</li></ul><h2>NOT Included (20-35% additional)</h2><ul><li>Professional fees: Design consultants (5-8%), Project management (3-5%), Engineers (2-4%)</li><li>Authority approvals: Building permits, Civil Defense, Municipality fees</li><li>Landlord requirements: Security deposits, NOC fees, access charges</li><li>VAT (5% UAE, 15% KSA), contingency reserves (5-10%), insurance</li></ul><div style="margin-top:40px;padding-top:20px;border-top:2px solid #e0e0e0;text-align:center;font-size:9pt;color:#666"><p><strong style="color:#f97316">Contact:</strong> info@thetemplrock.com</p><p style="margin-top:10px">TRDB - Professional Fit-Out Cost Estimates | www.thetemplrock.com</p></div><div class="no-print"><button onclick="window.print()" style="padding:15px 30px;background:#f97316;color:white;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer">üìÑ Download PDF</button><button onclick="window.close()" style="padding:15px 30px;background:#64748b;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;margin-left:10px">‚úï Close</button></div></body></html>`);
                    pdfWindow.document.close();
                }

                render() {
                    this.renderUserControls();
                    this.renderApp();
                }

                renderUserControls() {
                    const controls = document.getElementById('userControls');
                    
                    if (this.user) {
                        controls.innerHTML = `
                            <button class="btn btn-secondary" onclick="App.setView('estimates')">My Estimates</button>
                            <div class="user-info">${this.user.displayName || this.user.email}</div>
                            <button class="btn btn-danger" onclick="App.logout()">Logout</button>
                        `;
                    } else {
                        controls.innerHTML = `
                            <button class="btn btn-primary" onclick="App.showAuthModal('login')">Login / Sign Up</button>
                        `;
                    }
                }

                renderApp() {
                    const app = document.getElementById('app');
                    
                    if (this.view === 'home') {
                        app.innerHTML = this.renderHome();
                    } else if (this.view === 'calculator') {
                        app.innerHTML = this.renderCalculator();
                    } else if (this.view === 'results') {
                        app.innerHTML = this.renderResults();
                    } else if (this.view === 'estimates') {
                        app.innerHTML = this.renderEstimates();
                    }
                }

                renderHome() {
                    const recentEstimates = this.savedEstimates.slice(0, 3);
                    
                    return `
                        <div class="hero">
                            <h1>Professional Fit-Out Cost Estimates</h1>
                            <p>Instant, accurate estimates for your commercial space in the Middle East</p>
                            <button class="btn btn-primary" onclick="App.setView('calculator')" style="font-size: 18px; padding: 20px 40px;">
                                Get Your Estimate Now
                            </button>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">üìà</div>
                                <div class="stat-title">95% Accuracy</div>
                                <div class="stat-desc">Based on real market data</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">üèÜ</div>
                                <div class="stat-title">15+ Years</div>
                                <div class="stat-desc">Industry experience</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">üë•</div>
                                <div class="stat-title">500+ Projects</div>
                                <div class="stat-desc">Successfully delivered</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">‚ö°</div>
                                <div class="stat-title">Instant Results</div>
                                <div class="stat-desc">Get estimates in seconds</div>
                            </div>
                        </div>

                        ${recentEstimates.length > 0 ? `
                            <div style="margin-top: 60px;">
                                <h2 style="font-size: 32px; margin-bottom: 30px; text-align: center;">Your Recent Estimates</h2>
                                <div class="saved-estimates-grid">
                                    ${recentEstimates.map(est => `
                                        <div class="estimate-card">
                                            <div class="estimate-card-header">
                                                <div class="estimate-card-title">${est.config.market.toUpperCase()}</div>
                                                <div class="estimate-card-meta">${this.fmt(est.config.size)} SqFt ¬∑ ${est.config.quality}</div>
                                                <div class="estimate-card-date">${est.savedAt ? new Date(est.savedAt.toDate()).toLocaleDateString() : 'Recently saved'}</div>
                                            </div>
                                            <div class="estimate-card-amount">
                                                <div class="estimate-card-price">
                                                    AED ${this.fmt(est.estimate.total.min)} - ${this.fmt(est.estimate.total.max)}
                                                </div>
                                            </div>
                                            <button class="btn btn-primary" onclick='App.loadEstimate(${JSON.stringify(est)})' style="width: 100%;">
                                                Load Estimate
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    `;
                }

                renderCalculator() {
                    if (!this.config.market) {
                        return `
                            <div class="card">
                                <h2>Step 1: Select Your Market</h2>
                                <div class="market-grid">
                                    <button class="market-btn" onclick="App.selectMarket('dubai')">Dubai</button>
                                    <button class="market-btn" onclick="App.selectMarket('abudhabi')">Abu Dhabi</button>
                                    <button class="market-btn" onclick="App.selectMarket('riyadh')">Riyadh</button>
                                    <button class="market-btn" onclick="App.selectMarket('jeddah')">Jeddah</button>
                                </div>
                            </div>
                        `;
                    }

                    return `
                        <div class="card">
                            <h2>Step 2: Project Details - ${this.config.market.toUpperCase()}</h2>
                            
                            <div class="form-group">
                                <label>Project Size</label>
                                <div class="slider-value">${this.fmt(this.config.size)} SqFt</div>
                                <input type="range" min="1000" max="50000" step="500" value="${this.config.size}" 
                                    onchange="App.updateSize(this.value)">
                            </div>

                            <div class="form-group">
                                <label>Quality Level</label>
                                <div class="quality-grid">
                                    <button class="quality-btn ${this.config.quality === 'basic' ? 'active' : ''}" 
                                        onclick="App.selectQuality('basic')">Basic</button>
                                    <button class="quality-btn ${this.config.quality === 'standard' ? 'active' : ''}" 
                                        onclick="App.selectQuality('standard')">Standard</button>
                                    <button class="quality-btn ${this.config.quality === 'premium' ? 'active' : ''}" 
                                        onclick="App.selectQuality('premium')">Premium</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Additional Options</label>
                                <div class="options-list">
                                    ${this.renderOption('furniture', 'Furniture Supply (+10%)')}
                                    ${this.renderOption('ffe', 'Loose FF&E (+9%)')}
                                    ${this.renderOption('green', 'Green/LEED (+8%)')}
                                    ${this.renderOption('smart', 'Smart Workplace (+6%)')}
                                    ${this.renderOption('mep', 'Full MEP Plant (+18%)')}
                                    ${this.renderOption('av', 'Advanced AV/IT (+5%)')}
                                </div>
                            </div>

                            <div class="button-group">
                                <button class="btn btn-secondary" onclick="App.backToMarket()">Back</button>
                                <button class="btn btn-primary" onclick="App.calculate()">Calculate Estimate</button>
                            </div>
                        </div>
                    `;
                }

                renderOption(key, label) {
                    return `
                        <label class="option-item ${this.config.options[key] ? 'selected' : ''}">
                            <input type="checkbox" ${this.config.options[key] ? 'checked' : ''} 
                                onchange="App.toggleOption('${key}')">
                            ${label}
                        </label>
                    `;
                }

                renderResults() {
                    if (!this.estimate) return '';

                    const optionLabels = {
                        furniture: 'Furniture Supply (+10%)',
                        ffe: 'Loose FF&E (+9%)',
                        green: 'Green/LEED (+8%)',
                        smart: 'Smart Workplace (+6%)',
                        mep: 'Full MEP Plant (+18%)',
                        av: 'Advanced AV/IT (+5%)'
                    };

                    const optionPercentages = {
                        furniture: 0.10,
                        ffe: 0.09,
                        green: 0.08,
                        smart: 0.06,
                        mep: 0.18,
                        av: 0.05
                    };

                    return `
                        <div class="card">
                            <h2>Your Estimate</h2>

                            <div class="estimate-highlight">
                                <div class="estimate-label">Total Estimated Investment</div>
                                <div class="estimate-amount">
                                    AED ${this.fmt(this.estimate.total.min)} - ${this.fmt(this.estimate.total.max)}
                                </div>
                                <div class="estimate-details">
                                    ${this.fmt(this.config.size)} SqFt ¬∑ ${this.config.market.toUpperCase()} ¬∑ ${this.config.quality} quality
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Project Details</label>
                                <div class="details-grid">
                                    <div class="detail-box">
                                        <div class="detail-label">Location</div>
                                        <div class="detail-value">${this.config.market.toUpperCase()}</div>
                                    </div>
                                    <div class="detail-box">
                                        <div class="detail-label">Project Size</div>
                                        <div class="detail-value">${this.fmt(this.config.size)} SqFt</div>
                                    </div>
                                    <div class="detail-box">
                                        <div class="detail-label">Quality Level</div>
                                        <div class="detail-value" style="text-transform: capitalize;">${this.config.quality}</div>
                                    </div>
                                    <div class="detail-box">
                                        <div class="detail-label">Cost per SqFt</div>
                                        <div class="detail-value">AED ${this.estimate.perSqFt.min} - ${this.estimate.perSqFt.max}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Cost Breakdown</label>
                                <div class="card" style="background: rgba(15, 23, 42, 0.8); padding: 20px;">
                                    <div class="breakdown-table">
                                        <div class="breakdown-row">
                                            <span>Base Construction</span>
                                            <span style="font-weight: bold;">AED ${this.fmt(this.estimate.base.min)} - ${this.fmt(this.estimate.base.max)}</span>
                                        </div>
                                        ${Object.keys(this.config.options)
                                            .filter(key => this.config.options[key])
                                            .map(key => `
                                                <div class="breakdown-row">
                                                    <span>${optionLabels[key]}</span>
                                                    <span style="font-weight: bold;">
                                                        +AED ${this.fmt(Math.round(this.estimate.base.min * optionPercentages[key]))} - 
                                                        ${this.fmt(Math.round(this.estimate.base.max * optionPercentages[key]))}
                                                    </span>
                                                </div>
                                            `).join('')}
                                        <div class="breakdown-row total">
                                            <span>TOTAL ESTIMATE</span>
                                            <span>AED ${this.fmt(this.estimate.total.min)} - ${this.fmt(this.estimate.total.max)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button class="btn btn-secondary" onclick="App.showDetailsModal()" style="width: 100%; margin-bottom: 20px;">
                                View Full Scope Details
                            </button>

                            <div class="button-group" style="grid-template-columns: ${this.user ? 'repeat(3, 1fr)' : 'repeat(2, 1fr)'};">
                                <button class="btn btn-secondary" onclick="App.startNew()">Start New Estimate</button>
                                ${this.user ? '<button class="btn" onclick="App.saveEstimate()" style="background: #0891b2; color: white;">üíæ Save Estimate</button>' : ''}
                                <button class="btn btn-primary" onclick="App.showLeadModal()">Get Your Estimate</button>
                            </div>
                        </div>
                    `;
                }

                renderEstimates() {
                    if (this.savedEstimates.length === 0) {
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                                <h2 style="font-size: 32px;">My Saved Estimates</h2>
                                <button class="btn btn-secondary" onclick="App.setView('home')">Back to Home</button>
                            </div>
                            <div class="empty-state">
                                <h3>No saved estimates yet</h3>
                                <p>Create your first estimate to see it here</p>
                                <button class="btn btn-primary" onclick="App.setView('calculator')">Create Estimate</button>
                            </div>
                        `;
                    }

                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                            <h2 style="font-size: 32px;">My Saved Estimates</h2>
                            <button class="btn btn-secondary" onclick="App.setView('home')">Back to Home</button>
                        </div>

                        <div class="saved-estimates-grid">
                            ${this.savedEstimates.map(est => `
                                <div class="estimate-card">
                                    <div class="estimate-card-header">
                                        <div class="estimate-card-title">${est.config.market.toUpperCase()}</div>
                                        <div class="estimate-card-meta">${this.fmt(est.config.size)} SqFt ¬∑ ${est.config.quality}</div>
                                        <div class="estimate-card-date">
                                            Saved: ${est.savedAt ? new Date(est.savedAt.toDate()).toLocaleDateString() : 'Recently'} 
                                            ${est.savedAt ? 'at ' + new Date(est.savedAt.toDate()).toLocaleTimeString() : ''}
                                        </div>
                                    </div>
                                    <div class="estimate-card-amount">
                                        <div class="estimate-card-price">
                                            AED ${this.fmt(est.estimate.total.min)} - ${this.fmt(est.estimate.total.max)}
                                        </div>
                                    </div>
                                    <div class="estimate-card-actions">
                                        <button class="btn btn-primary" onclick='App.loadEstimate(${JSON.stringify(est)})' style="flex: 1;">
                                            Load
                                        </button>
                                        <button class="btn btn-danger" onclick="App.deleteEstimate('${est.id}')">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Actions
                setView(view) {
                    this.view = view;
                    this.render();
                }

                selectMarket(market) {
                    this.config.market = market;
                    this.render();
                }

                backToMarket() {
                    this.config.market = '';
                    this.render();
                }

                updateSize(size) {
                    this.config.size = parseInt(size);
                    this.render();
                }

                selectQuality(quality) {
                    this.config.quality = quality;
                    this.render();
                }

                toggleOption(key) {
                    this.config.options[key] = !this.config.options[key];
                    this.render();
                }

                calculate() {
                    this.calculateEstimate();
                    this.view = 'results';
                    this.render();
                }

                startNew() {
                    this.config = {
                        market: '',
                        size: 5000,
                        quality: 'standard',
                        options: {
                            furniture: false,
                            ffe: false,
                            green: false,
                            smart: false,
                            mep: false,
                            av: false
                        }
                    };
                    this.estimate = null;
                    this.view = 'calculator';
                    this.render();
                }
            }

            // Initialize app
            window.App = new TRDBEstimator();
        });
    </script>
</body>
</html>
